#!/bin/bash
#
# Copyright (c) 2019-2023, ProvenRun and/or its affiliates. All rights reserved.
#
# Original author: Alexandre Berdery
#
#

function check_mkimage() {
    mkimage_type_list=$($1 -T list 2>&1 >/dev/null)
    if [[ $mkimage_type_list != *"stm32image"* ]]; then
        echo "1"
    fi
    echo "0"
}

# Check if "-T stm32image" is available:
#  - either by default
#  - or in mkimage provided through PNC_STM32_MKIMAGE_PATH
MKIMAGE=mkimage
res=$(check_mkimage ${MKIMAGE})
if [ "$res" != 0 ]; then
    if [ "x${PNC_STM32_MKIMAGE_PATH}" == "x" ]; then
        echo "Support for -T stm32image not found in default mkimage tool (${MKIMAGE})."
        echo "Please provide alternate path through PNC_STM32_MKIMAGE_PATH"
        exit 1
    fi
    MKIMAGE=${PNC_STM32_MKIMAGE_PATH}
    res=$(check_mkimage ${MKIMAGE})
    if [ "$res" != 0 ]; then
        echo "Invalid PNC_STM32_MKIMAGE_PATH:${PNC_STM32_MKIMAGE_PATH}"
        echo "Please update PNC_STM32_MKIMAGE_PATH"
        exit 1
    fi
fi

set -eu
set -o pipefail

. ${BASE_DIR}/scripts/build/common_utils.sh
. ${BUILD_BASE}/kernel_limits.mk

IMG_DIR=${BUILD_BASE}/images
provencore_img=${IMG_DIR}/provencore.img
mkdir -p ${IMG_DIR}

${MKIMAGE} -A arm -T stm32image -C none \
    -a ${KERNEL_LOAD_ADDR} \
    -e ${KERNEL_START_ADDR} \
    -n "ProvenCore" \
    -d ${BUILD_BASE}/provencore.bin \
    ${provencore_img}

echo "${provencore_img} is ready"
